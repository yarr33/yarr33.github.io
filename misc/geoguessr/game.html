<script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBIwzALxUPNbatRBj3Xi1Uhp0fFzwWNBkE&callback=init&libraries=&v=weekly"
    async></script>
<script>

    let panorama;
    let map;
    let guessingLat;
    let guessingLon;
    let userLat;
    let userLon;
    let time;

    let option_minimumReward;
    let option_maximumReward;
    let option_skipCost;
    let option_guessType;
    let option_maximumRewardDistance;
    let option_rounds;
    let option_timeLimit;

    let score;
    let round = 1;
    let guessingTime = false;
    let guessDistance;
    let rewardPoints;
    let saved = false;
    let locked = false;

    let guessMarker;

    let recordedRounds = [];

    function startGame() {
        //getting the game options
        option_minimumReward = document.getElementById("min-points-guess").value;
        option_maximumReward = document.getElementById("max-points-guess").value;
        option_skipCost = document.getElementById("points-skip").value;
        option_guessType = document.getElementById("guessing-type").value
        option_maximumRewardDistance = document.getElementById("min-distance").value
        option_rounds = document.getElementById("rounds").value
        option_timeLimit = parseInt(document.getElementById("time").value)

        //fixing the values
        if (option_maximumReward < 1) option_maximumReward = 1
        if (option_minimumReward < 0) option_minimumReward = 0
        if (option_minimumReward > option_maximumReward) option_minimumReward = 0
        if (option_skipCost < 0) option_skipCost = 0
        if (option_maximumRewardDistance < 2) option_maximumRewardDistance = 2
        if (option_rounds < 2) option_rounds = 2
        if (option_rounds > 20) option_rounds = 40

        //starting...
        document.getElementById("game-container").style.display = "block"
        document.getElementById("options").style.display = "none"
        document.getElementById("round-text").innerHTML = "round 1/" + option_rounds
        document.getElementById("map-container").style = ""
        document.getElementById("score-text").innerHTML = "score 0"
        document.getElementById("time-text").innerHTML = "no time limit"
        score = 0
        round = 1

        if (option_timeLimit) {
            time = option_timeLimit
            document.getElementById("time-text").innerHTML = time + " seconds left"
            setInterval(updateTime, 1000)
        }

        setGuessingActive(false)
        showMap()
        findLoc()
    }

    function nextRound() {
        guessMarker.setMap(null)
        recordedRounds.push([new google.maps.LatLng(guessingLat, guessingLon), guessDistance, rewardPoints, saved])
        round++
        saved = false;
        if (round > option_rounds) { showWin() }
        else {
            setGuessingActive(false)
            document.getElementById("guess-container").style.display = "block"
            document.getElementById("guess-feedback").style.display = "none"
            document.getElementById("round-text").innerHTML = "round " + round + "/" + option_rounds
            document.getElementById("score-text").innerHTML = "score " + score
            document.getElementById("save-text").innerHTML = "&nbsp;·&nbsp;save"
            time = option_timeLimit
            findLoc()
        }
    }

    function updateTime() {
        if (guessingTime) {
            if (time == 0) {
                document.getElementById("time-text").innerHTML = "time ran out!"
                document.getElementById("time-text").style.color = "red"
                guessingTime = false
                skip()
            } else {
                document.getElementById("time-text").innerHTML = time + " seconds left"
                document.getElementById("time-text").style.color = "black"
                time--;
            }
        }
    }

    function skip() {
        if (score > option_skipCost) score -= option_skipCost
        guessDistance = "skipped"
        rewardPoints = 0
        nextRound()
    }

    function setGuessingActive(active = true) {
        document.getElementById("skip-button").disabled = !active
    }

    function init(){
        document.getElementById("start-button").disabled = false
    }

    function showMap() {
        const earthbound = {
            north: 85,
            south: -85,
            west: -179,
            east: 179,
        };

        const pan = { lat: 0, lng: 0 };
        map = new google.maps.Map(document.getElementById("map"), {
            zoom: 1.4,
            center: pan,
            restriction: {
                latLngBounds: earthbound,
            },
        });

        guessMarker = new google.maps.Marker({
            position: new google.maps.LatLng(0, 0),
            map: null,
        });

        map.addListener("click", (event) => {
            guessMarker.setMap(map)
            guessMarker.setPosition(event.latLng)
            movedPositionString = event.latLng + ""
            movedPositionString = movedPositionString.replace("(", "")
            movedPositionString = movedPositionString.replace(")", "")
            userLat = parseFloat(movedPositionString.split(",")[0])
            userLon = parseFloat(movedPositionString.split(",")[1])
            document.getElementById("guess-button").disabled = false
        });
    }

    function findLoc() {
        //setting up service
        var streetViewService = new google.maps.StreetViewService();

        //searching for location
        //generating position
        lat = Math.floor((Math.random() * 180 - 90) * 1000) / 1000
        lon = Math.floor((Math.random() * 360 - 180) * 1000) / 1000
        var latLng = new google.maps.LatLng(lat, lon);

        //trying get panorama
        streetViewService.getPanoramaByLocation(latLng, 50000, function (streetViewPanoramaData, status) {
            if (status === google.maps.StreetViewStatus.OK) {
                //reading location
                guessingLat = streetViewPanoramaData.location.latLng.lat()
                guessingLon = streetViewPanoramaData.location.latLng.lng()

                //creating the map
                document.getElementById("street-view").innerHTML = ""
                panorama = new google.maps.StreetViewPanorama(
                    document.getElementById("street-view"),
                    {
                        position: { lat: guessingLat, lng: guessingLon },
                        pov: { heading: 165, pitch: 0 },
                        zoom: 0,
                    }
                );

                if (option_guessType = "dynamic") {
                    //making sure the panorama updates it's guessing spot
                    panorama.addListener("position_changed", () => {
                        movedPosition = panorama.getPosition()
                        movedPositionString = movedPosition + ""
                        movedPositionString = movedPositionString.replace("(", "")
                        movedPositionString = movedPositionString.replace(")", "")
                        guessingLat = parseFloat(movedPositionString.split(",")[0])
                        guessingLon = parseFloat(movedPositionString.split(",")[1])
                    });
                }

                guessingTime = true

                setGuessingActive()
            } else {
                findLoc()
            }
        });

    }

    function guess() {
        if (userLon == null) {
            alert("select a location first!")
            return
        } else {
            guessingTime = false
            document.getElementById("guess-button").disabled = true
            map.panTo(new google.maps.LatLng(0, 0))
            map.setZoom(0.5)
            guessDistance = distance(guessMarker) * 1.60934;
            rounded = 0
            unit = ""
            if (guessDistance > 1) {
                unit = "km"
                rounded = Math.round(guessDistance)
                if (guessDistance < 101) {
                    rounded = Math.round(guessDistance * 10) / 10
                }
            } else {
                unit = "m"
                rounded = Math.round(guessDistance * 1000)
            }

            document.getElementById("guess-container").style.display = "none"
            document.getElementById("guess-feedback").style.display = "block"

            stringDistance = rounded + unit

            document.getElementById("distance-feedback").innerHTML = "your guess is " + stringDistance + " from the chosen spot."
            document.getElementById("feedback-coordinates").innerHTML = "coordinates: " + guessingLat + ", " + guessingLon
            document.getElementById("maps-location").href = "https://www.google.com/maps/place/" + guessingLat + "," + guessingLon

            paragraph = ""

            if (guessDistance < 0.1) paragraph = "OH. MY. GOD. that's hyperexact!!!"
            else if (guessDistance < 1) paragraph = "WOW! you are amazing!!!"
            else if (guessDistance < 100) paragraph = "whooo! what a nice guess!"
            else if (guessDistance < 500) paragraph = "that's so close! bravo!"
            else if (guessDistance < 1000) paragraph = "very nice guess."
            else if (guessDistance < 2000) paragraph = "cool!"
            else if (guessDistance < 10000) paragraph = "good guess... let's not mistake countries."
            else if (guessDistance < 15000) paragraph = "whoa that's far. I wish you more luck next time!"
            else if (guessDistance < 50000) paragraph = "hmmm... ummmm..."

            document.getElementById("feedback-paragraph").innerHTML = paragraph

            rewardPoints = 0

            if (guessDistance > option_maximumRewardDistance) rewardPoints = option_minimumReward
            else { rewardPoints = option_maximumReward * ((option_maximumRewardDistance - guessDistance) / option_maximumRewardDistance) }

            rewardPoints = Math.round(rewardPoints)

            document.getElementById("feedback-points").innerHTML = "+" + rewardPoints
            score += rewardPoints

            hue = 115 * (rewardPoints / option_maximumReward)
            document.getElementById("feedback-points").style = "color: hsl(" + hue + ", 100%, 50%)"

            const earthbound = {
                north: 85,
                south: -85,
                west: -179,
                east: 179,
            };

            //yes, the earth is flat.
            avgLat = (userLat + guessingLat) / 2
            avgLon = (userLon + guessingLon) / 2



            pan = { lat: avgLat, lng: avgLon };
            const fmap = new google.maps.Map(document.getElementById("feedback-map"), {
                zoom: 2,
                minZoom: 2,
                center: pan,
                restriction: {
                    latLngBounds: earthbound,
                },
            });

            m1 = new google.maps.Marker({
                position: new google.maps.LatLng(guessingLat, guessingLon),
                map: fmap,
                icon: "http://maps.google.com/mapfiles/ms/icons/green-dot.png",
            });

            m2 = new google.maps.Marker({
                position: new google.maps.LatLng(userLat, userLon),
                map: fmap,
                icon: "http://maps.google.com/mapfiles/ms/icons/red-dot.png",
            });


            new google.maps.Polyline({ path: [new google.maps.LatLng(userLat, userLon), new google.maps.LatLng(guessingLat, guessingLon)], map: fmap });

            setGuessingActive(false)

        }
    }

    function distance(mk) {
        var R = 3958.8; // Radius of the Earth in miles
        var rlat1 = guessingLat * (Math.PI / 180); // Convert degrees to radians
        var rlat2 = mk.position.lat() * (Math.PI / 180); // Convert degrees to radians
        var difflat = rlat2 - rlat1; // Radian difference (latitudes)
        var difflon = (mk.position.lng() - guessingLon) * (Math.PI / 180); // Radian difference (longitudes)

        var d = 2 * R * Math.asin(Math.sqrt(Math.sin(difflat / 2) * Math.sin(difflat / 2) + Math.cos(rlat1) * Math.cos(rlat2) * Math.sin(difflon / 2) * Math.sin(difflon / 2)));
        return d;
    }

    function showWin() {
        document.getElementById("game-container").style.display = "none"
        document.getElementById("finish").style.display = "block"

        document.getElementById("finish-score").innerHTML = "you've got " + score + " / " + (option_maximumReward * option_rounds) + " points."

        table = document.getElementById("round-summary")

        roundIndex = 0
        recordedRounds.forEach(roundData => {
            roundIndex++
            row = document.createElement('tr');
            row.innerHTML = `
                  <th>`+ (roundIndex) + [" ", " ☆"][{ true: 1, false: 0 }[roundData[3]]] + `</th>
                  <th>`+ roundData[2] + `</th>
                  <th>`+ roundData[1] + `</th>
                  <th>`+ ((roundData[0] + "").replace("(", "").replace(")", "")) + `</th>
                  <th><a href="`+ "https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=" + ((roundData[0] + "").replace(" ", "").replace("(", "").replace(")", "")) + `">view in google maps</a></th>
        `
            table.appendChild(row)
        });

    }

    function saveLocation() {
        document.getElementById("save-text").innerHTML = "&nbsp;·&nbsp;saved ✓"
        saved = true
    }

    function toggleLock() {
        locked = !locked
        if (!locked) {
            document.getElementById("map-container").className = "midloc"
            setTimeout(function () { document.getElementById("map-container").className = "lockable" }, 1000)
            document.getElementById("lock-button").innerHTML = "lock"
        } else {
            document.getElementById("lock-button").innerHTML = "unlock"
            document.getElementById("map-container").className = "unlockable"
        }
    }

</script>


<body>
    <div id="topbar" style="width: 100%; background-color: white; display: block;">

        <a href="home.html"><button>back</button></a>
        <b style="margin-left:auto;margin-right:auto;text-align:center">geoguessr improved</b>
    </div>

    <br>

    <div id="options" style="font-size: 20px;display: block;">
        <b>&nbsp;Options</b>
        <p>&nbsp;scoring</p>
        <div id="spliter"></div>
        <small>&nbsp;maximum points per guess:</small> <input type="number" id="max-points-guess" value="5000" min="1"
            max="1000000"></input>
        <small>&nbsp;&nbsp;minimum points per guess:</small> <input type="number" id="min-points-guess" value="0"
            min="0" max="1000000"></input>
        <small>&nbsp;&nbsp;skip cost:</small> <input type="number" id="points-skip" value="0" min="0"
            max="100000"></input>

        <p>&nbsp;guessing</p>
        <div id="spliter"></div>
        <small>&nbsp;guessing type:</small>
        <select id="guessing-type">
            <option value="static">player position</option>
            <option value="dynamic">initial position</option>
        </select>
        <small>&nbsp;&nbsp;time limit:</small>
        <select id="time">
            <option value="0">none</option>
            <option value="30">30s</option>
            <option value="60">60s</option>
            <option value="90">90s</option>
            <option value="180">2m</option>
            <option value="240">5m</option>
        </select>
        <small>&nbsp;&nbsp;maximum distance to gain points:</small> <input type="number" id="min-distance" value="6000"
            min="0" max="20000"></input><small>km</small>
        <small>&nbsp;&nbsp;rounds:</small> <input type="number" id="rounds" value="8" min="2" max="40"></input>
        <br>
        <button id="start-button" onclick="startGame()"
            style="position:absolute; bottom: 2%; right: 2%; background-color: rgba(49, 49, 49, 0.137); color:rgb(44, 44, 44); " disabled><b
                style="font-size: 20px;">Play!</b></button>
    </div>

    <div id="game-container"
        style="margin-left:auto;margin-right:auto;text-align:center;width: 100%;height: 93%; display: none;">

        <div id="guess-container" style="position: relative;">
            <div id="street-view" style="height: 97%;"></div>
            <div id="map-container" class="lockable" style="height: 0%;">
                <div id="map" style="position: absolute;"></div>
                <button id="guess-button"
                    style="position: absolute; top: 1%; left:1%; z-index: 3; background-color:rgba(58, 58, 58, 0.151) ;"
                    onclick="guess()" disabled><b>guess!</b></button>
                <button id="lock-button"
                    style="position: absolute; top:1%; right:1%; z-index: 3; background-color:rgba(58, 58, 58, 0.151);"
                    onclick="toggleLock()"><b>lock</b></button>
            </div>




        </div>

        <div id="guess-feedback" style="background-color: white; height: 90%; width: 100%; display: none;">
            <br>
            <div style="margin-left:auto;margin-right:auto;width: 100%; text-align: center;">
                <b id="distance-feedback" style="font-size: 34px; text-align: center;">your guess was ____ from the
                    destination</b>
                <br><br>
                <div id="feedback-map" style="width: 45%; height: 80%; position: relative; left: 4%;"></div>
            </div>
            <div id="info-panel" style="position: absolute; top: 15%; left: 50%; text-align: left;"></br>
                <b style="color: rgb(86, 212, 86)">■ chosen spot</b></br>
                <b style="color: rgb(230, 31, 24)">■ your guess</b></br></br>
                <b id="feedback-coordinates">coordinates: </b><b>&nbsp;&nbsp;<a id="maps-location" href="">view in
                        maps</a></b><br><br><br>
                <b id="feedback-paragraph"></b><br>
                <b id="feedback-points"></b>
                <div style="position:relative;">
                    <button id="next-button" onclick="nextRound()"
                        style="position:absolute; right: 0.3%; background-color: rgba(49, 49, 49, 0.137); color:rgb(44, 44, 44); "><b>next
                            ▶
                </div>
            </div>
        </div>


        <div style="background-color: rgb(238, 238, 238); height: 30px;">
            &nbsp;
            <b id="round-text">round 3/3</b>
            <b>&nbsp;·&nbsp;</b>
            <b id="score-text">score 0</b>
            <b>&nbsp;·&nbsp;</b>
            <b id="time-text">no time limit</b>
            <b id="save-text" onclick="saveLocation()">&nbsp;·&nbsp;save</b>
            <button id="skip-button" onclick="skip()"
                style="position:absolute; right: 0.3%; background-color: rgba(49, 49, 49, 0.137); color:rgb(44, 44, 44); "><b>skip
                    ▶
                </b></button>
            </br>
        </div>


    </div>

    <div id="finish" style="background-color: white; min-height: 90%; width: 100%; display: none;">
        <div style="margin-left:auto;margin-right:auto;width: 100%; text-align: center;"><br>
            <b style="font-size: 42px; text-align: center;">congratulations!</b><br><br>
            <b id="finish-score">you've got X points.</b><br><br>
            <table id="round-summary" style="width: 100%;border: 1px solid #dddddd;">
                <tr>
                    <th>round</th>
                    <th>score</th>
                    <th>distance</th>
                    <th>location</th>
                    <th>street view</th>
                </tr>
            </table><br><br><br><button onclick="location.reload()"
                style=" background-color: rgba(49, 49, 49, 0.137); color:rgb(44, 44, 44);"><b>play again</b></button>
        </div>
    </div>


</body>

<style>
    td,
    th {
        text-align: left;
        padding: 6px;
    }

    tr:nth-child(even) {
        background-color: #dddddd;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: rgb(238, 255, 232);
    }

    button {
        border-color: rgba(0, 0, 0, 0);
        width: 100px;
        height: 30px;
        outline: none;
    }

    .gm-iv-address {
        visibility: hidden;
    }

    .gm-fullscreen-control {
        visibility: hidden;
    }

    .gmnoprint {
        visibility: hidden;
    }

    #street-view {
        height: 100%;
    }

    #options {
        position: relative;
        left: 3%;
        border: solid;
        border-color: rgba(7, 7, 7, 0.11);
        border-width: 3px;
        background-color: cornsilk;
        width: 92%;
        height: 80%;
    }

    p {
        color: rgb(112, 112, 112);
    }

    #spliter {
        background-color: rgba(7, 7, 7, 0.041);
        width: 99%;
        margin-left: auto;
        margin-right: auto;
        border: solid;
        border-color: rgba(7, 7, 7, 0.041);
        border-width: 1px;
        position: relative;
        top: -19px;
    }

    input {
        background-color: rgba(49, 49, 49, 0.137);
        border-width: 1px;
        border-color: rgba(58, 58, 58, 0.11);
        font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
        outline: none;
        width: 50px;
    }

    select {
        background-color: rgba(49, 49, 49, 0.137);
        border-width: 1px;
        border-color: rgba(58, 58, 58, 0.11);
        font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
        outline: none;
    }

    #map {
        height: 100%;
        width: 100%;
        z-index: 1;
        position: absolute;
        top: 0px;
        left: 0px;
    }

    #map-container.lockable {
        height: 150px;
        width: 150px;
        animation-name: mapUnextend;
        animation-duration: 0.4s;
        position: absolute;
        top: 5px;
        left: 5px;
    }

    #map-container.midloc {
        height: 150px;
        width: 150px;
        animation-name: mapUnextend;
        animation-duration: 0.4s;
        position: absolute;
        top: 5px;
        left: 5px;
    }

    #map-container.lockable:hover {
        animation-name: mapExtend;
        height: 600px;
        width: 600px;
    }

    #map-container.unlockable {
        height: 600px;
        width: 600px;
        position: absolute;
        top: 5px;
        left: 5px;
    }

    @keyframes mapExtend {
        from {
            height: 150px;
            width: 150px;
        }

        to {
            height: 600px;
            width: 600px;
        }
    }

    @keyframes mapUnextend {
        from {
            height: 600px;
            width: 600px;
        }

        to {
            height: 150px;
            width: 150px;
        }
    }

    #lock-button {
        display: none;
    }

    #lock-button {
        display: none;
    }

    #guess-button {
        width: 99%
    }

    #map-container:hover #lock-button {
        display: block;
    }

    #map-container:hover #guess-button {
        width: 90%
    }

    #lock-button {
        width: 7%;
    }

    #map-container.unlockable #lock-button {
        display: block;
        width: 12%;
    }

    #map-container.unlockable #guess-button {
        width: 85%;
    }
</style>